name: Deploy Backend
on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-backend-prod
  cancel-in-progress: false

defaults:
  run:
    working-directory: backend

jobs:
  deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: us-west-2
        role-to-assume: arn:aws:iam::265978616089:role/rankings-deployment-role-prod
        role-session-name: RankingsDeployProd

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.10.5"

    - name: Setup buildx
      uses: docker/setup-buildx-action@v3

    - name: Deploy
      run: "./deploy.sh prod"

    - name: Trigger immediate ECS task run
      run: |
        # Get the latest task definition
        TASK_DEF=$(aws ecs describe-task-definition \
          --task-definition rankings-backend-prod \
          --query 'taskDefinition.taskDefinitionArn' \
          --output text)
        
        # Get subnets from the existing scheduled task
        SUBNETS=$(aws scheduler get-schedule \
          --name rankings-backend-prod \
          --query 'Target.EcsParameters.NetworkConfiguration.awsvpcConfiguration.Subnets' \
          --output json)
        
        # Run the task
        aws ecs run-task \
          --cluster rankings-backend-prod \
          --task-definition "$TASK_DEF" \
          --launch-type FARGATE \
          --network-configuration "awsvpcConfiguration={subnets=$SUBNETS,assignPublicIp=ENABLED}" \
          --count 1
        
        echo "âœ… Triggered ECS task run in prod"
