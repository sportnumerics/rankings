name: PR Validation
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  id-token: write
  contents: read
  pull-requests: write

concurrency:
  group: pr-validation-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  validate:
    name: Test, Deploy, and Validate
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment: dev

    steps:
    # ===== 1. UNIT TESTS =====
    - name: Checkout
      uses: actions/checkout@v4

    - name: Run backend unit tests
      working-directory: backend
      run: |
        if ! command -v uv &> /dev/null; then
          pip install uv
        fi
        # Find all test files and convert to module names
        test_modules=$(find lib -name 'test_*.py' -type f | sed 's|/|.|g' | sed 's|.py$||')
        uv run python -m unittest $test_modules

    # ===== 2. DEPLOY FRONTEND & BACKEND TO DEV =====
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Restore Next.js cache
      uses: actions/cache@v4
      with:
        path: frontend/.next/cache
        key: ${{ runner.os }}-nextjs-${{ hashFiles('frontend/package-lock.json') }}-${{ hashFiles('frontend/**/*.js', 'frontend/**/*.jsx', 'frontend/**/*.ts', 'frontend/**/*.tsx') }}
        restore-keys: |
          ${{ runner.os }}-nextjs-${{ hashFiles('frontend/package-lock.json') }}-

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: us-west-2
        role-to-assume: arn:aws:iam::265978616089:role/rankings-deployment-role-dev
        role-session-name: RankingsPRValidation

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.10.5"

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Deploy frontend to dev
      working-directory: frontend
      run: ./deploy.sh dev

    - name: Deploy backend to dev
      working-directory: backend
      run: ./deploy.sh dev

    # ===== 3. TRIGGER AND WAIT FOR BACKEND RUN =====
    - name: Trigger backend ECS task (limited scrape)
      working-directory: backend
      run: |
        # Trigger task and capture ARN
        TASK_ARN=$(aws ecs run-task \
          --task-definition $(aws ecs list-task-definitions --family-prefix rankings-backend-dev --sort DESC --max-items 1 | jq -r '.taskDefinitionArns[0]') \
          --cluster rankings-backend-dev \
          --launch-type FARGATE \
          --network-configuration "awsvpcConfiguration={subnets=[subnet-f728fa92,subnet-866f9ff1],assignPublicIp=ENABLED}" \
          --overrides '{"containerOverrides":[{"name":"rankings-backend","environment":[{"name":"YEAR","value":"2026"},{"name":"SCRAPE_LIMIT","value":"5"}]}]}' \
          --query 'tasks[0].taskArn' \
          --output text)
        
        echo "TASK_ARN=$TASK_ARN" >> $GITHUB_ENV
        echo "Triggered task: $TASK_ARN"

    - name: Wait for backend task to complete
      run: |
        echo "Waiting for task $TASK_ARN to complete..."
        aws ecs wait tasks-stopped \
          --cluster rankings-backend-dev \
          --tasks $TASK_ARN \
          --max-attempts 60 \
          --delay 10
        
        # Check exit code
        EXIT_CODE=$(aws ecs describe-tasks \
          --cluster rankings-backend-dev \
          --tasks $TASK_ARN \
          --query 'tasks[0].containers[0].exitCode' \
          --output text)
        
        echo "Task exited with code: $EXIT_CODE"
        
        if [ "$EXIT_CODE" != "0" ]; then
          echo "Backend task failed!"
          exit 1
        fi

    # ===== 4. RUN E2E TESTS =====
    - name: Install Playwright (Chromium)
      working-directory: frontend
      run: npx playwright install --with-deps chromium

    - name: Run E2E smoke tests
      working-directory: frontend
      env:
        BASE_URL: https://dev.sportnumerics.com
      run: npm run e2e

    - name: Upload Playwright report (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: frontend/playwright-report/
        if-no-files-found: ignore

    # ===== SUCCESS COMMENT =====
    - name: Comment on PR
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âœ… **PR validation passed!**\n\n- Unit tests passed\n- Deployed to dev: https://dev.sportnumerics.com\n- Backend task completed successfully\n- E2E smoke tests passed\n\nReady to merge!'
          })
