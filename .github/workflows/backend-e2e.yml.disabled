name: Backend E2E

on:
  pull_request:
    paths:
      - 'backend/**'
      - '.github/workflows/backend-e2e.yml'
  workflow_dispatch:
    inputs:
      year:
        description: 'Year to scrape (defaults to current year)'
        required: false

permissions:
  id-token: write
  contents: read

defaults:
  run:
    working-directory: backend

jobs:
  e2e-test:
    name: Build, scrape, predict, and sync to dev
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set year
      id: set-year
      run: |
        YEAR="${{ inputs.year }}"
        if [ -z "$YEAR" ]; then
          YEAR=$(date +%Y)
        fi
        echo "year=$YEAR" >> $GITHUB_OUTPUT
        echo "Using year: $YEAR"

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: us-west-2
        role-to-assume: arn:aws:iam::265978616089:role/rankings-deployment-role-dev
        role-session-name: RankingsBackendE2E

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build backend container
      run: |
        docker build --platform linux/amd64 -t rankings-backend:e2e .

    - name: Create output directory
      run: mkdir -p out

    - name: Scrape MCLA teams
      run: |
        docker run --rm \
          -v $(pwd)/out:/app/out \
          --entrypoint uv \
          rankings-backend:e2e \
          run main.py --year ${{ steps.set-year.outputs.year }} scrape --source mcla teams

    - name: Scrape MCLA schedules (limited to 5 teams)
      run: |
        docker run --rm \
          -v $(pwd)/out:/app/out \
          --entrypoint uv \
          rankings-backend:e2e \
          run main.py --year ${{ steps.set-year.outputs.year }} scrape --source mcla schedules --limit 5

    - name: Scrape NCAA teams
      run: |
        docker run --rm \
          -v $(pwd)/out:/app/out \
          --entrypoint uv \
          rankings-backend:e2e \
          run main.py --year ${{ steps.set-year.outputs.year }} scrape --source ncaa teams

    - name: Scrape NCAA schedules (limited to 5 teams)
      run: |
        docker run --rm \
          -v $(pwd)/out:/app/out \
          --entrypoint uv \
          rankings-backend:e2e \
          run main.py --year ${{ steps.set-year.outputs.year }} scrape --source ncaa schedules --limit 5

    - name: Run predictions
      run: |
        docker run --rm \
          -v $(pwd)/out:/app/out \
          --entrypoint uv \
          rankings-backend:e2e \
          run main.py --year ${{ steps.set-year.outputs.year }} predict

    - name: Verify MCLA output files exist
      run: ./scripts/verify-output-files.sh ${{ steps.set-year.outputs.year }} out 5 mcla

    - name: Verify NCAA output files exist
      run: ./scripts/verify-output-files.sh ${{ steps.set-year.outputs.year }} out 5 ncaa

    - name: Sync to dev S3
      run: |
        docker run --rm \
          -v $(pwd)/out:/app/out \
          -e AWS_REGION=$AWS_REGION \
          -e AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID \
          -e AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY \
          -e AWS_SESSION_TOKEN=$AWS_SESSION_TOKEN \
          --entrypoint uv \
          rankings-backend:e2e \
          run main.py sync --bucket-url s3://sportnumerics-rankings-bucket-dev/data

    - name: Verify dev S3 sync
      run: ./scripts/verify-s3-sync.sh ${{ steps.set-year.outputs.year }} s3://sportnumerics-rankings-bucket-dev/data

    - name: Upload output artifacts (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: backend-e2e-output
        path: backend/out/
        if-no-files-found: ignore
